<!DOCTYPE html>
<html lang="ca">
<head>
    <meta property="og:image" content="public/icon-app.svg">
    <link rel="icon" href="public/icon-app.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="public/icon-app.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:image" content="https://victor-catala-1971.netlify.app/images/icon-app.svg">
    <meta property="og:title" content="Aniversaris familiars">
    <meta property="og:description" content="Gesti√≥ d'aniversaris familiars">
    <meta property="og:type" content="website">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://victor-catala-1971.netlify.app/victor-catala-1971.html">
    <title>Aniversaris familiars</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
        }
        
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 100%;
            width: 100%;
            animation: fadeIn 0.6s ease-out;
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0 20px 0;
            letter-spacing: -0.5px;
        }

        h1 img {
            width: 35px;
            height: 35px;
            vertical-align: middle;
            margin-right: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        select {
            margin-bottom: 15px;
            padding: 12px 15px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            width: 100%;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover {
            border-color: #667eea;
            background-color: white;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        #chartContainer {
            height: 60vh;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .imatge-container {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .imatge-container img {
            max-width: 50%;
            height: auto;
            border-radius: 8px;
        }
        
        .checkbox-container {
            margin-bottom: 20px;
            padding: 14px 18px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .checkbox-container:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            color: #495057;
        }

        .checkbox-container input[type="checkbox"] {
            margin: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        /* Estilos para el modal de contrase√±a */
        #passwordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.4s ease-out;
        }

        .login-container {
            background-color: white;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
        }

        .login-container img {
            width: 90px;
            height: 90px;
            margin-bottom: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .login-container p {
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: #6c757d;
        }

        .login-container button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            margin-top: 15px;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .login-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .login-container button:active {
            transform: translateY(0);
        }

        .login-container input {
            width: 100%;
            padding: 14px 18px;
            margin: 10px 0;
            box-sizing: border-box;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            text-align: center;
            transition: all 0.3s ease;
        }

        .login-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        #logoutButton {
            padding: 10px 20px;
            margin: 10px 0;
            background: linear-gradient(135deg, #ee5a6f 0%, #f29263 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            align-self: flex-end;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(238, 90, 111, 0.4);
            transition: all 0.3s ease;
        }

        #logoutButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 90, 111, 0.6);
        }

        #logoutButton:active {
            transform: translateY(0);
        }

        /* Bot√≥n de env√≠o de emails */
        .send-emails-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            z-index: 998;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-emails-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .send-emails-btn:active {
            transform: translateY(0);
        }

        .send-emails-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Bot√≥n de env√≠o de SMS */
        .send-sms-btn {
            position: fixed;
            bottom: 20px;
            left: 170px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            z-index: 998;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-sms-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .send-sms-btn:active {
            transform: translateY(0);
        }

        .send-sms-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Bot√≥n flotante para cerrar sesi√≥n en m√≥viles */
        @media (max-width: 768px) {
            #logoutButton {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 100;
                padding: 10px 15px;
                border-radius: 30px;
            }

            .mainContent {
                width: 100%;
            }

            .container {
                margin-bottom: 60px;
                padding: 15px;
            }

            body {
                padding: 5px;
            }

            .send-emails-btn {
                padding: 10px 20px;
                font-size: 0.85rem;
                bottom: 90px;
                left: 20px;
            }

            .send-sms-btn {
                padding: 10px 20px;
                font-size: 0.85rem;
                bottom: 90px;
                left: 150px;
            }
        }

        /* Ocultar el contenido principal hasta que se verifique la contrase√±a */
        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-weight: 500;
        }

        /* Barra de b√∫squeda */
        .search-container {
            margin-bottom: 15px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 18px;
        }

        /* Widget de pr√≥ximos cumplea√±os */
        .upcoming-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 16px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            cursor: pointer;
        }

        .upcoming-widget h3 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .upcoming-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .upcoming-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }

        .upcoming-item:last-child {
            margin-bottom: 0;
        }

        /* Estad√≠sticas */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Modal de detalles */
        .details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .details-modal.show {
            display: flex;
        }

        .details-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        .details-content h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }

        .details-info {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .close-modal {
            background: linear-gradient(135deg, #ee5a6f 0%, #f29263 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 90, 111, 0.4);
        }

        /* Modal de confirmaci√≥n */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease-out;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            text-align: center;
        }

        .confirm-content h3 {
            color: #d32f2f;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }

        .confirm-content p {
            color: #666;
            margin: 10px 0;
        }

        .confirm-content ul {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .confirm-content ul li {
            background: #ffebee;
            padding: 8px 15px;
            margin: 5px 0;
            border-radius: 8px;
            color: #c62828;
            font-weight: 500;
        }

        .confirm-btn {
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .confirm-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .confirm-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .confirm-btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .confirm-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        /* Toggle modo oscuro */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        /* Modo oscuro */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .container {
            background-color: #0f3460;
            color: #e4e4e4;
        }

        body.dark-mode h1 {
            -webkit-text-fill-color: #e4e4e4;
            background: none;
        }

        body.dark-mode .search-input,
        body.dark-mode select {
            background-color: #1a1a2e;
            color: #e4e4e4;
            border-color: #2d2d44;
        }

        body.dark-mode .checkbox-container,
        body.dark-mode .stat-card {
            background: #1a1a2e;
            border-color: #2d2d44;
            color: #e4e4e4;
        }

        body.dark-mode .stat-label,
        body.dark-mode .checkbox-container label {
            color: #b8b8b8;
        }

        body.dark-mode .theme-toggle {
            background: #0f3460;
            border-color: #2d2d44;
        }

        /* Animaci√≥n de transici√≥n entre meses */
        .chart-transition {
            animation: chartFadeIn 0.5s ease-out;
        }

        @keyframes chartFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Modal de √°rbol geneal√≥gico */
        .family-tree-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            overflow: hidden;
        }

        .family-tree-modal.show {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }

        .family-tree-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-tree-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .family-tree-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .family-tree-close:hover {
            background: white;
            color: #667eea;
            transform: rotate(90deg);
        }

        .family-tree-container {
            flex: 1;
            position: relative;
            background: #fafafa;
            overflow: hidden;
        }

        #familyTreeSVG {
            width: 100%;
            height: 100%;
        }

        /* Controles de zoom del √°rbol */
        .tree-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .tree-control-btn {
            width: 45px;
            height: 45px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            font-size: 1.3rem;
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 600;
        }

        .tree-control-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        /* Estilos de nodos del √°rbol D3 */
        .tree-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tree-node:hover {
            transform: scale(1.05);
        }

        .tree-node-circle {
            fill: #667eea;
            stroke: #764ba2;
            stroke-width: 3px;
            transition: all 0.3s ease;
        }

        .tree-node-circle.deceased {
            fill: #9ca3af;
            stroke: #6b7280;
        }

        .tree-node-circle.female {
            fill: #ec4899;
            stroke: #db2777;
        }

        .tree-node:hover .tree-node-circle {
            stroke-width: 5px;
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
        }

        .tree-node.dragging .tree-node-circle {
            stroke-width: 6px;
            filter: drop-shadow(0 0 12px rgba(102, 126, 234, 0.8));
            opacity: 0.7;
        }

        .tree-node-text {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
        }

        .tree-node-initials {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            font-weight: 700;
            fill: white;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }

        .tree-node-subtext {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 400;
            fill: #6c757d;
            text-anchor: middle;
            pointer-events: none;
        }

        .tree-link {
            fill: none;
            stroke: #cbd5e0;
            stroke-width: 2px;
        }

        .tree-link-partner {
            stroke: #f687b3;
            stroke-width: 3px;
            stroke-dasharray: 5, 5;
        }

        /* Nodos de uni√≥n de parejas */
        .tree-node-circle.couple-union {
            fill: #fbbf24;
            stroke: #f59e0b;
            stroke-width: 2px;
            opacity: 0.8;
        }

        .tree-node:hover .tree-node-circle.couple-union {
            opacity: 1;
            stroke-width: 3px;
            filter: drop-shadow(0 0 6px rgba(251, 191, 36, 0.6));
        }

        /* Leyenda */
        .family-tree-legend {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .family-tree-header h2 {
                font-size: 1.2rem;
            }

            .tree-controls {
                top: 10px;
                right: 10px;
                gap: 5px;
            }

            .tree-control-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }

            .family-tree-legend {
                flex-direction: column;
                gap: 10px;
                font-size: 0.85rem;
                padding: 12px 20px;
            }
        }

        /* Modo oscuro para modal de √°rbol */
        body.dark-mode .family-tree-container {
            background: #16213e;
        }

        body.dark-mode .tree-node-text {
            fill: #e4e4e4;
        }

        body.dark-mode .tree-control-btn {
            background: #0f3460;
            color: #e4e4e4;
            border-color: #e4e4e4;
        }

        body.dark-mode .tree-control-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        body.dark-mode .family-tree-legend {
            background: #0f3460;
            color: #e4e4e4;
        }

        /* Vista de calendario */
        .calendar-view {
            display: block;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            color: #667eea;
            font-size: 0.9rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .calendar-day:hover {
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .calendar-day.has-birthday {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* D√≠a actual destacado con borde dorado */
        .calendar-day.is-today {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5), 0 0 25px rgba(251, 191, 36, 0.3);
            position: relative;
        }

        /* Cuando el d√≠a actual tiene cumplea√±os, combinar ambos estilos */
        .calendar-day.is-today.has-birthday {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6), 0 0 25px rgba(251, 191, 36, 0.4);
        }

        /* Animaci√≥n sutil para el d√≠a actual */
        @keyframes pulse-today {
            0%, 100% {
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.5), 0 0 25px rgba(251, 191, 36, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.7), 0 0 35px rgba(251, 191, 36, 0.5);
            }
        }

        .calendar-day.is-today {
            animation: pulse-today 2s ease-in-out infinite;
        }

        .calendar-day.other-month {
            opacity: 0.3;
            pointer-events: none;
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-birthday-count {
            position: absolute;
            top: 4px;
            right: 4px;
            background: white;
            color: #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .calendar-birthday-names {
            font-size: 0.65rem;
            margin-top: 4px;
            line-height: 1.2;
        }

        /* Toggle de vista */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .view-toggle-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #6c757d;
        }

        .view-toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Bot√≥n flotante de agregar */
        .add-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 3px solid white;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.8);
            }
        }

        /* Animaciones para el widget de countdown */
        @keyframes countdownPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glow {
            0%, 100% {
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
            }
            50% {
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 30px rgba(255, 255, 255, 0.5);
            }
        }

        /* Clases para activar animaciones al tocar el widget */
        .upcoming-widget.active .glow-text {
            animation: glow 2s ease-in-out 2;
        }

        .upcoming-widget.active .pulse-counter {
            animation: countdownPulse 1.5s ease-in-out 3;
        }

        .add-btn:hover {
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.8);
            animation: none;
        }

        .add-btn::before {
            content: '‚ûï Afegir';
            position: absolute;
            right: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .add-btn:hover::before {
            opacity: 1;
        }

        /* Bot√≥n flotante de √°rbol geneal√≥gico */
        .tree-btn {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: floatTree 3s ease-in-out infinite;
        }

        @keyframes floatTree {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .tree-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.8);
            animation: none;
        }

        .tree-btn::before {
            content: 'üå≥ Arbre';
            position: absolute;
            left: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .tree-btn:hover::before {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .tree-btn {
                bottom: 80px;
                left: 15px;
                width: 65px;
                height: 65px;
                font-size: 32px;
            }

            .tree-btn::before {
                font-size: 12px;
                padding: 6px 12px;
                left: 75px;
            }
        }

        /* Modal de formulario */
        .form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease-out;
            overflow-y: auto;
            padding: 20px;
        }

        .form-modal.show {
            display: flex;
        }

        .form-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        .form-content h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 20px 0;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .form-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        .form-btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .form-btn-secondary:hover {
            background: #dee2e6;
        }

        .form-btn-danger {
            background: linear-gradient(135deg, #ee5a6f 0%, #f29263 100%);
            color: white;
        }

        .form-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(238, 90, 111, 0.5);
        }

        /* Optimizaci√≥n del modal para m√≥vil */
        @media (max-width: 768px) {
            .form-modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .form-content {
                max-height: 85vh;
                padding: 20px 15px;
                margin-bottom: 10px;
            }

            .form-content h3 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group input,
            .form-group select {
                padding: 10px 12px;
                font-size: 16px; /* Evitar zoom autom√°tico en iOS */
            }

            .form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .form-actions .form-btn {
                width: 100%;
            }

            /* Ajustes del widget de countdown para m√≥vil */
            .upcoming-widget {
                padding: 15px;
            }

            #upcomingList {
                font-size: 0.9rem !important;
            }

            #upcomingList > div {
                font-size: 1rem !important;
            }

            #upcomingList strong {
                font-size: 1.1rem !important;
            }
        }

        /* Indicador de swipe */
        .swipe-indicator {
            text-align: center;
            padding: 10px;
            color: #6c757d;
            font-size: 0.85rem;
            font-style: italic;
        }

        body.dark-mode .calendar-view,
        body.dark-mode .form-content {
            background: #0f3460;
            color: #e4e4e4;
        }

        body.dark-mode .calendar-day {
            background: #1a1a2e;
            border-color: #2d2d44;
            color: #e4e4e4;
        }

        body.dark-mode .view-toggle {
            background: #1a1a2e;
            border-color: #2d2d44;
        }

        body.dark-mode .form-group label {
            color: #e4e4e4;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select {
            background: #1a1a2e;
            color: #e4e4e4;
            border-color: #2d2d44;
        }

        @media (max-width: 768px) {
            .add-btn {
                bottom: 80px;
                right: 15px;
                width: 65px;
                height: 65px;
                font-size: 32px;
            }

            .add-btn::before {
                font-size: 12px;
                padding: 6px 12px;
                right: 75px;
            }

            .calendar-grid {
                gap: 2px;
            }

            .calendar-day-header {
                padding: 4px 1px;
                font-size: 0.65rem;
            }

            .calendar-day {
                padding: 1px;
                font-size: 0.65rem;
                min-height: 45px;
            }

            .calendar-day-number {
                font-size: 0.65rem;
            }

            .calendar-birthday-count {
                width: 14px;
                height: 14px;
                font-size: 0.55rem;
                top: 1px;
                right: 1px;
            }

            .calendar-birthday-names {
                font-size: 0.45rem;
                line-height: 1.0;
                overflow: hidden;
                text-overflow: ellipsis;
                max-height: 22px;
            }

            .calendar-view {
                padding: 5px;
            }

            .calendar-header {
                margin-bottom: 10px;
            }

            .calendar-header h3 {
                font-size: 1.1rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de contrase√±a -->
    <div id="passwordModal">
        <div class="login-container">
            <img src="public/icon-login.svg" alt="Aniversaris familiars">
            <h2>Aniversaris familiars</h2>
            <p>Si us plau, introdueix la contrasenya per accedir:</p>
            <input type="password" id="passwordInput" placeholder="contrasenya">
            <button onclick="checkPassword()">Accedir</button>
        </div>
    </div>

    <!-- Toggle modo oscuro -->
    <div class="theme-toggle" id="themeToggle" title="Cambiar tema">
        üåô
    </div>

    <!-- Contenido principal (inicialmente oculto) -->
    <div class="mainContent hidden">
        <button id="logoutButton">Tancar sessi√≥</button>
        <button id="sendEmailsBtn" class="send-emails-btn" onclick="sendBirthdayEmailsManually()" title="Enviar felicitacions d'avui">
            üìß Enviar emails
        </button>
        <button id="sendSmsBtn" class="send-sms-btn" onclick="sendBirthdaySMSManually()" title="Enviar SMS d'avui">
            üì± Enviar SMS
        </button>

        <div class="container">
            <h1><img src="public/icon-login.svg" alt="Aniversaris familiars">Aniversaris familiars</h1>
            <div class="imatge-container">
                <img src="public/placeholder-familia.svg" alt="Aniversaris familiars" style="max-width: 50%; height: auto; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);" />
            </div>

            <!-- Widget de pr√≥ximos cumplea√±os (ahora muestra countdown) -->
            <div class="upcoming-widget" id="upcomingWidget">
                <div id="upcomingList" style="font-size: 1rem; color: white; line-height: 1.8; font-weight: 500;"></div>
            </div>

            <!-- Estad√≠sticas del mes -->
            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-month" id="statMonth" style="font-size: 1.3rem; font-weight: 600; margin-bottom: 8px;"></div>
                    <div class="stat-label" id="statMotivation" style="font-size: 0.9rem;"></div>
                </div>
                <div class="stat-card" style="max-height: 200px; overflow-y: auto;">
                    <div class="stat-label" style="margin-bottom: 10px; font-weight: 600;">Aniversaris del mes</div>
                    <div id="statBirthdayList" style="font-size: 0.85rem; line-height: 1.6;"></div>
                </div>
            </div>

            <!-- Barra de b√∫squeda -->
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar per nom...">
            </div>

            <!-- Contenedor de resultados de b√∫squeda -->
            <div id="searchResults" style="display: none; margin-bottom: 20px;"></div>

            <select id="mesSelector"></select>

            <!-- Indicador de swipe m√≥vil -->
            <div class="swipe-indicator">üëà Llisca per canviar de mes üëâ</div>

            <!-- Vista de calendario -->
            <div class="calendar-view" id="calendarView">
                <div id="calendarContent"></div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante de agregar -->
    <button class="add-btn hidden" id="addBtn" onclick="openAddModal()" title="Afegir aniversari">
        +
    </button>

    <!-- Bot√≥n flotante de √°rbol geneal√≥gico -->
    <button class="tree-btn hidden" id="treeBtn" onclick="openFamilyTree()" title="Veure arbre familiar">
        üå≥
    </button>

    <!-- Modal de formulario -->
    <div class="form-modal" id="formModal">
        <div class="form-content">
            <h3 id="formTitle">Afegir Aniversari</h3>
            <form id="birthdayForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="formNom">Nom *</label>
                    <input type="text" id="formNom" required placeholder="Nom complet">
                </div>
                <div class="form-group">
                    <label for="formDia">Dia *</label>
                    <input type="number" id="formDia" min="1" max="31" required placeholder="1-31">
                </div>
                <div class="form-group">
                    <label for="formMes">Mes *</label>
                    <select id="formMes" required>
                        <option value="">Selecciona un mes</option>
                        <option value="1">Gener</option>
                        <option value="2">Febrer</option>
                        <option value="3">Mar√ß</option>
                        <option value="4">Abril</option>
                        <option value="5">Maig</option>
                        <option value="6">Juny</option>
                        <option value="7">Juliol</option>
                        <option value="8">Agost</option>
                        <option value="9">Setembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Desembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="formAnyNaixement">Any de naixement *</label>
                    <input type="number" id="formAnyNaixement" min="1900" max="2025" placeholder="Ex: 1971">
                </div>
                <div class="form-group">
                    <label for="formTelefon">Tel√®fon *</label>
                    <input type="text" id="formTelefon" placeholder="N√∫mero de tel√®fon">
                </div>
                <div class="form-group">
                    <label for="formEmail">Email *</label>
                    <input type="email" id="formEmail" placeholder="correu@example.com">
                </div>
                <div class="form-group">
                    <label for="formGenere">G√®nere *</label>
                    <select id="formGenere">
                        <option value="">No especificat</option>
                        <option value="H">Home</option>
                        <option value="D">Dona</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="formViu">Estat *</label>
                    <select id="formViu">
                        <option value="">No especificat</option>
                        <option value="S√≠">Viu</option>
                        <option value="No">En mem√≤ria</option>
                    </select>
                </div>

                <!-- Secci√≥n de relaciones familiares -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 15px; font-size: 1.05rem;">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Relacions familiars (opcional)
                    </div>

                    <div class="form-group">
                        <label for="formPare">Pare</label>
                        <select id="formPare">
                            <option value="">No especificat</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="formMare">Mare</label>
                        <select id="formMare">
                            <option value="">No especificat</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="formParella">Parella</label>
                        <select id="formParella">
                            <option value="">No especificat</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="formUrlFoto">Foto (URL)</label>
                        <input type="url" id="formUrlFoto" placeholder="https://exemple.com/foto.jpg">
                        <small style="color: #6c757d; font-size: 0.85rem; display: block; margin-top: 5px;">
                            Opcional: enlla√ß a una imatge
                        </small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="form-btn form-btn-secondary" onclick="closeFormModal()">Cancel¬∑lar</button>
                    <button type="button" id="deleteBtn" class="form-btn form-btn-danger hidden" onclick="deleteBirthday()">Eliminar</button>
                    <button type="submit" class="form-btn form-btn-primary" onclick="saveBirthday()">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de detalles -->
    <div class="details-modal" id="detailsModal">
        <div class="details-content">
            <h3 id="detailsName"></h3>
            <div class="details-info">
                <strong>üìÖ Data:</strong> <span id="detailsDate"></span>
            </div>
            <div class="details-info" id="detailsAgeContainer" style="display: none;">
                <strong>üéÇ Edat:</strong> <span id="detailsAge"></span>
            </div>
            <div class="details-info">
                <strong>üìû Tel√®fon:</strong> <span id="detailsPhone"></span>
            </div>
            <div class="details-info">
                <strong>üìß Email:</strong> <span id="detailsEmail"></span>
            </div>
            <div class="details-info">
                <strong>‚è∞ Dies fins al pr√≤xim aniversari:</strong> <span id="detailsDays"></span>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="close-modal" style="flex: 1;" onclick="openEditModal()">‚úèÔ∏è Editar</button>
                <button class="close-modal" style="flex: 1; background: linear-gradient(135deg, #6c757d 0%, #495057 100%);" onclick="closeDetailsModal()">Tancar</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para campos incompletos -->
    <div class="confirm-modal" id="confirmModal" style="display: none;">
        <div class="confirm-content">
            <h3>‚ö†Ô∏è Camps incomplets</h3>
            <p>Falten els seg√ºents camps per emplenar:</p>
            <ul id="missingFieldsList" style="text-align: left; margin: 15px 0; color: #d32f2f;"></ul>
            <p style="margin-top: 15px;">Vols completar-los ara o guardar igualment?</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="confirm-btn confirm-btn-secondary" onclick="closeConfirmModal()">Completar ara</button>
                <button class="confirm-btn confirm-btn-primary" onclick="saveAnywayConfirmed()">Guardar igualment</button>
            </div>
        </div>
    </div>

    <!-- Modal de √°rbol geneal√≥gico -->
    <div class="family-tree-modal" id="familyTreeModal">
        <div class="family-tree-header">
            <h2>üå≥ Arbre Geneal√≤gic Familiar</h2>
            <button class="family-tree-close" onclick="closeFamilyTree()" title="Tancar (ESC)">
                ‚úï
            </button>
        </div>
        <div class="family-tree-container" id="familyTreeContainer">
            <!-- El √°rbol se renderizar√° aqu√≠ con D3.js -->
            <div class="tree-controls">
                <button class="tree-control-btn" onclick="zoomInTree()" title="Ampliar">+</button>
                <button class="tree-control-btn" onclick="zoomOutTree()" title="Reduir">‚àí</button>
                <button class="tree-control-btn" onclick="resetZoomTree()" title="Reiniciar vista">‚ü≤</button>
                <button class="tree-control-btn" onclick="resetTreeLayout()" title="Reiniciar posicions">‚Ü∫</button>
            </div>
            <div class="family-tree-legend">
                <div class="legend-item">üîµ Home</div>
                <div class="legend-item">üî¥ Dona</div>
                <div class="legend-item">üïäÔ∏è En mem√≤ria</div>
                <div class="legend-item">üíï Parella</div>
            </div>
        </div>
    </div>

    <script>
        // Sistema de contrase√±a con hash SHA-256
    
        const correctPasswordHash = "8505c821e124e939f3342d2cd2a1d8d2694f395d217284ed4d9fcdbd11ed25f0";

        // Funci√≥n para generar hash SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Funci√≥n para verificar la contrase√±a
        async function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const passwordHash = await hashPassword(password);

            if (passwordHash === correctPasswordHash) {
                // Generar token de sesi√≥n √∫nico
                const sessionToken = btoa(Date.now() + Math.random().toString(36));
                localStorage.setItem('victorCatalaAuth', sessionToken);
                localStorage.setItem('victorCatalaAuthTime', Date.now().toString());
                document.getElementById('passwordModal').style.display = 'none';
                document.querySelector('.mainContent').classList.remove('hidden');
                initializeApp();
            } else {
                alert('Contrassenya incorrecta. Si us plau, intenta-ho novament.');
                document.getElementById('passwordInput').value = '';
            }
        }

        // Funci√≥n para verificar si la sesi√≥n es v√°lida (expira despu√©s de 24 horas)
        function isSessionValid() {
            const authToken = localStorage.getItem('victorCatalaAuth');
            const authTime = localStorage.getItem('victorCatalaAuthTime');

            if (!authToken || !authTime) return false;

            const currentTime = Date.now();
            const sessionAge = currentTime - parseInt(authTime);
            const maxSessionAge = 24 * 60 * 60 * 1000; // 24 horas

            return sessionAge < maxSessionAge;
        }

        // Base de datos de aniversarios (se carga din√°micamente desde Google Sheets)
        const dadesAniversaris = [];

        // Frases motivadoras para cada mes
        const frasesMotivadores = [
            "üéä Any nou, nous desitjos! Comencem amb energia!", // Gener
            "üíï Febrer, el mes de l'amor i l'amistat!", // Febrer
            "üå∏ Primavera arriba, celebrem la vida!", // Mar√ß
            "üåßÔ∏è Abril, aig√ºes mil... i aniversaris tamb√©!", // Abril
            "üå∫ Maig floreix, i nosaltres tamb√©!", // Maig
            "‚òÄÔ∏è Comen√ßa l'estiu, celebrem junts!", // Juny
            "üéâ Juliol de vacances i alegria!", // Juliol
            "üåû Agost, sol i amistats que duren!", // Agost
            "üçÇ Tardor de somriures i records!", // Setembre
            "üéÉ Octubre, castanyada i celebracions!", // Octubre
            "üçÅ Novembre, temps de records i gratitud!", // Novembre
            "üéÑ Nadal arriba, celebrem amb il¬∑lusi√≥!" // Desembre
        ];

        // Configuraci√≥n de Google Sheets API
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyH_zxFyGjYs2oT-fvssGAnNNXavfZmWeoXW6coCOGoNxTOqHAqTjgNYz7chxG2Kang3g/exec';
        let isSyncing = false;

        // ============================================
        // M√ìDULO DE API PARA GOOGLE SHEETS
        // ============================================

        /**
         * Cargar todos los aniversarios desde Google Sheets
         */
        async function fetchBirthdays() {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                const result = await response.json();

                // Verificar modo mantenimiento
                if (result.maintenance) {
                    showMaintenanceMode(result.message);
                    return null;
                }

                if (result.success && result.data) {
                    return result.data;
                } else {
                    console.error('Error al cargar datos:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('Error de red al cargar aniversarios:', error);
                return null;
            }
        }

        /**
         * Mostrar pantalla de mantenimiento
         */
        function showMaintenanceMode(message) {
            document.body.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100vh;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    text-align: center;
                    padding: 20px;
                ">
                    <div style="font-size: 5rem; margin-bottom: 20px;">üîß</div>
                    <h1 style="font-size: 2.5rem; margin: 0 0 20px 0; font-weight: 600;">Manteniment</h1>
                    <p style="font-size: 1.3rem; max-width: 600px; line-height: 1.6; opacity: 0.95;">
                        ${message || 'En manteniment, disculpa les mol√®sties. En breu tornem'}
                    </p>
                    <button onclick="location.reload()" style="
                        margin-top: 30px;
                        padding: 12px 30px;
                        font-size: 1rem;
                        background: white;
                        color: #667eea;
                        border: none;
                        border-radius: 25px;
                        cursor: pointer;
                        font-weight: 600;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üîÑ Tornar a intentar
                    </button>
                </div>
            `;
        }

        /**
         * A√±adir un nuevo aniversario a Google Sheets
         */
        async function addBirthdayToSheet(birthday) {
            if (isSyncing) return { success: false, error: 'Sincronizaci√≥n en curso' };
            isSyncing = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'CREATE',
                        data: birthday
                    })
                });

                const result = await response.json();
                isSyncing = false;

                if (result.success) {
                    console.log('Aniversario a√±adido a Google Sheets');
                }
                return result; // Retornar el resultado completo con tipo de error si existe
            } catch (error) {
                isSyncing = false;
                console.error('Error de red al a√±adir:', error);
                return { success: false, error: error.toString() };
            }
        }

        /**
         * A√±adir un aniversario forzadamente (sin validaci√≥n de duplicados)
         */
        async function addBirthdayToSheetForzado(birthday) {
            if (isSyncing) return { success: false, error: 'Sincronizaci√≥n en curso' };
            isSyncing = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'CREATE_FORCE',
                        data: birthday
                    })
                });

                const result = await response.json();
                isSyncing = false;

                if (result.success) {
                    console.log('Aniversario a√±adido forzadamente a Google Sheets');
                }
                return result;
            } catch (error) {
                isSyncing = false;
                console.error('Error de red al a√±adir forzadamente:', error);
                return { success: false, error: error.toString() };
            }
        }

        /**
         * Actualizar un aniversario existente en Google Sheets
         */
        async function updateBirthdayInSheet(oldData, newData) {
            if (isSyncing) return false;
            isSyncing = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'UPDATE',
                        oldData: oldData,
                        newData: newData
                    })
                });

                const result = await response.json();
                isSyncing = false;

                if (result.success) {
                    console.log('Aniversario actualizado en Google Sheets');
                    return true;
                } else {
                    console.error('Error al actualizar:', result.error);
                    return false;
                }
            } catch (error) {
                isSyncing = false;
                console.error('Error de red al actualizar:', error);
                return false;
            }
        }

        /**
         * Eliminar un aniversario de Google Sheets
         */
        async function deleteBirthdayFromSheet(birthday) {
            if (isSyncing) return false;
            isSyncing = true;

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'DELETE',
                        data: birthday
                    })
                });

                const result = await response.json();
                isSyncing = false;

                if (result.success) {
                    console.log('Aniversario eliminado de Google Sheets');
                    return true;
                } else {
                    console.error('Error al eliminar:', result.error);
                    return false;
                }
            } catch (error) {
                isSyncing = false;
                console.error('Error de red al eliminar:', error);
                return false;
            }
        }

        /**
         * Enviar emails de cumplea√±os manualmente
         */
        async function sendBirthdayEmailsManually() {
            // Verificar si hay cumplea√±os hoy
            const now = new Date();
            const cumpleHoy = dadesAniversaris.filter(d =>
                d.dia === now.getDate() && d.mes === (now.getMonth() + 1)
            );

            // Si no hay cumplea√±os hoy
            if (cumpleHoy.length === 0) {
                alert('No hi ha aniversaris avui per enviar emails.');
                return;
            }

            // Verificar si tienen emails
            const sinEmail = cumpleHoy.filter(d => !d.email || d.email.trim() === '');
            const conEmail = cumpleHoy.filter(d => d.email && d.email.trim() !== '');

            if (conEmail.length === 0) {
                alert(`Avui √©s l'aniversari de:\n\n${cumpleHoy.map(d => `‚Ä¢ ${d.nom}`).join('\n')}\n\nPer√≤ cap d'ells t√© email registrat.\n\nSi us plau, afegeix els emails primer.`);
                return;
            }

            // Mostrar informaci√≥n de a qui√©n se enviar√°
            let mensaje = '';
            if (conEmail.length > 0) {
                mensaje = `S'enviaran emails a:\n\n${conEmail.map(d => `‚úÖ ${d.nom}`).join('\n')}`;
            }
            if (sinEmail.length > 0) {
                mensaje += `\n\n‚ö†Ô∏è Sense email (no s'enviar√†):\n${sinEmail.map(d => `‚Ä¢ ${d.nom}`).join('\n')}`;
            }
            mensaje += '\n\nVols continuar?';

            if (!confirm(mensaje)) {
                return;
            }

            const btn = document.getElementById('sendEmailsBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Enviant...';

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'SEND_EMAILS'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSyncMessage('‚úÖ Emails enviats correctament', false);
                } else {
                    showSyncMessage('‚ö†Ô∏è Error: ' + (result.error || 'Error desconegut'), true);
                }

            } catch (error) {
                console.error('Error al enviar emails:', error);
                showSyncMessage('‚ö†Ô∏è Error de xarxa al enviar emails', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        /**
         * Enviar SMS de cumplea√±os manualmente
         */
        async function sendBirthdaySMSManually() {
            // Verificar si hay cumplea√±os hoy
            const now = new Date();
            const cumpleHoy = dadesAniversaris.filter(d =>
                d.dia === now.getDate() && d.mes === (now.getMonth() + 1)
            );

            // Si no hay cumplea√±os hoy
            if (cumpleHoy.length === 0) {
                alert('No hi ha aniversaris avui per enviar SMS.');
                return;
            }

            // Verificar si tienen tel√©fono
            const sinTelefon = cumpleHoy.filter(d => !d.telefon || d.telefon.toString().trim() === '');
            const conTelefon = cumpleHoy.filter(d => d.telefon && d.telefon.toString().trim() !== '');

            if (conTelefon.length === 0) {
                alert(`Avui √©s l'aniversari de:\n\n${cumpleHoy.map(d => `‚Ä¢ ${d.nom}`).join('\n')}\n\nPer√≤ cap d'ells t√© tel√®fon registrat.\n\nSi us plau, afegeix els tel√®fons primer.`);
                return;
            }

            // Mostrar informaci√≥n de a qui√©n se enviar√°
            let mensaje = '';
            if (conTelefon.length > 0) {
                mensaje = `S'enviaran SMS a:\n\n${conTelefon.map(d => `‚úÖ ${d.nom} (${d.telefon})`).join('\n')}`;
            }
            if (sinTelefon.length > 0) {
                mensaje += `\n\n‚ö†Ô∏è Sense tel√®fon (no s'enviar√†):\n${sinTelefon.map(d => `‚Ä¢ ${d.nom}`).join('\n')}`;
            }
            mensaje += '\n\nVols continuar?';

            if (!confirm(mensaje)) {
                return;
            }

            const btn = document.getElementById('sendSmsBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Enviant...';

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'SEND_SMS'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSyncMessage('‚úÖ SMS enviats correctament', false);
                } else {
                    showSyncMessage('‚ö†Ô∏è Error: ' + (result.error || 'Error desconegut'), true);
                }

            } catch (error) {
                console.error('Error al enviar SMS:', error);
                showSyncMessage('‚ö†Ô∏è Error de xarxa al enviar SMS', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        /**
         * Mostrar mensaje de sincronizaci√≥n
         */
        function showSyncMessage(message, isError = false) {
            const existingMsg = document.getElementById('syncMessage');
            if (existingMsg) existingMsg.remove();

            const msgDiv = document.createElement('div');
            msgDiv.id = 'syncMessage';
            msgDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isError ? 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)' : 'linear-gradient(135deg, #28a745 0%, #218838 100%)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 0.9rem;
                animation: slideIn 0.3s ease-out;
            `;
            msgDiv.textContent = message;
            document.body.appendChild(msgDiv);

            setTimeout(() => {
                msgDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => msgDiv.remove(), 300);
            }, 3000);
        }

        let chart;

        function getDiesMes(mes, any = 2025) {
            return new Date(any, mes, 0).getDate();
        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 200 + 55);
            const g = Math.floor(Math.random() * 200 + 55);
            const b = Math.floor(Math.random() * 200 + 55);
            return `rgba(${r}, ${g}, ${b}, 0.6)`;
        }

        function actualitzarGrafic(mes) {
            // Filtrar por mes y por b√∫squeda
            let aniversarisMes;

            if (currentSearchTerm) {
                aniversarisMes = searchBirthdays(currentSearchTerm).filter(d => d.mes === parseInt(mes));
            } else {
                aniversarisMes = dadesAniversaris.filter(d => d.mes === parseInt(mes));
            }

            aniversarisMes.sort((a, b) => a.dia - b.dia);

            // Actualizar estad√≠sticas
            updateMonthStats(mes);

            const chartContainer = document.getElementById('chartContainer');
            const canvas = document.getElementById('aniversarisChart');

            // Si no existe chartContainer, significa que no estamos en vista de gr√°fico
            if (!chartContainer) {
                console.log('No se puede actualizar gr√°fico: no estamos en vista de gr√°fico');
                return;
            }

            // Mostrar empty state si no hay resultados
            if (aniversarisMes.length === 0) {
                if (chart) chart.destroy();
                chartContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéÇ</div>
                        <div class="empty-state-text">No s'han trobat aniversaris${currentSearchTerm ? ' amb aquesta cerca' : ' aquest mes'}</div>
                    </div>
                `;
                return;
            }

            // Restaurar canvas si fue eliminado
            if (!canvas) {
                chartContainer.innerHTML = '<canvas id="aniversarisChart"></canvas>';
            }

            // A√±adir animaci√≥n
            chartContainer.classList.add('chart-transition');
            setTimeout(() => chartContainer.classList.remove('chart-transition'), 500);

            const diesMes = getDiesMes(mes);
            const mostrarTelefons = document.getElementById('mostrarTelefons').checked;

            const data = {
                labels: aniversarisMes.map(d => {
                    if (mostrarTelefons && d.telefon && d.telefon.trim() !== "") {
                        return `${d.dia} - ${d.nom} (${d.telefon})`;
                    } else {
                        return `${d.dia} - ${d.nom}`;
                    }
                }),
                datasets: [{
                    label: 'Dia de l\'aniversari',
                    data: aniversarisMes.map(d => d.dia),
                    backgroundColor: aniversarisMes.map(() => getRandomColor()),
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1
                }]
            };

            if (chart) {
                chart.destroy();
            }

            const ctx = document.getElementById('aniversarisChart').getContext('2d');

            // Registrar el plugin de datalabels
            Chart.register(ChartDataLabels);

            chart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const persona = aniversarisMes[index];
                            showBirthdayDetails(persona);
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: diesMes,
                            title: {
                                display: true,
                                text: 'Dia del mes'
                            }
                        },
                        y: {
                            ticks: {
                                autoSkip: false,
                                font: {
                                    size: function(context) {
                                        const width = window.innerWidth;
                                        return width < 768 ? 10 : 12;
                                    }
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Aniversaris ${getPrefixForMonth(mes)}${getMesName(mes)}`,
                            font: {
                                size: function(context) {
                                    const width = window.innerWidth;
                                    return width < 768 ? 14 : 16;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'start',
                            align: 'end',
                            formatter: function(value, context) {
                                return value;
                            },
                            font: {
                                weight: 'bold',
                                size: function(context) {
                                    const width = window.innerWidth;
                                    return width < 768 ? 10 : 12;
                                }
                            },
                            color: 'black',
                            offset: 4
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Click per veure detalls';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getMesName(mesNumber) {
            const mesos = ["", "Gener", "Febrer", "Mar√ß", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
            return mesos[parseInt(mesNumber)] || 'Mes desconegut';
        }

        function getPrefixForMonth(mesNumber) {
            const mesos = ["", "Gener", "Febrer", "Mar√ß", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
            const mesNom = mesos[parseInt(mesNumber)] || '';
            const primeraLletra = mesNom.charAt(0).toLowerCase();

            if (['a', 'e', 'i', 'o', 'u'].includes(primeraLletra)) {
                return "d'";
            } else {
                return "de ";
            }
        }

        function getFormattedToday() {
            const hoy = new Date();
            const dia = hoy.getDate();
            const mesNumber = hoy.getMonth() + 1;
            const mes = getMesName(mesNumber);
            const any = hoy.getFullYear();
            const prefix = getPrefixForMonth(mesNumber);
            return `Avui √©s ${dia} ${prefix}${mes} de ${any}`;
        }

        function getPrefixForName(nom) {
            const primeraLletra = nom.charAt(0).toLowerCase();
            return ['a','e','i','o','u','√†','√®','√©','√≠','√≤','√≥','√∫'].includes(primeraLletra) ? "d'" : "de ";
        }

        function joinNamesCatalan(noms) {
            if (noms.length === 1) return noms[0];
            if (noms.length === 2) return `${noms[0]} i ${noms[1]}`;
            return noms.slice(0, -1).join(", ") + " i " + noms[noms.length - 1];
        }

        function getNextBirthdays() {
            const today = new Date();
            const currentYear = today.getFullYear();

            // Filtrar solo personas con d√≠a y mes v√°lidos
            const proxims = dadesAniversaris
                .filter(d => d.dia && d.mes && !isNaN(d.dia) && !isNaN(d.mes))
                .map(d => {
                    const cumple = new Date(currentYear, d.mes - 1, d.dia);
                    const fecha = (cumple < today) ? new Date(currentYear + 1, d.mes - 1, d.dia) : cumple;
                    return { nom: d.nom, dia: d.dia, mes: d.mes, fecha };
                })
                .sort((a, b) => a.fecha - b.fecha);

            return proxims.slice(0, 2);
        }


        // Funci√≥n auxiliar para calcular el a√±o correcto seg√∫n el mes seleccionado
        function getYearForMonth(selectedMonth) {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            // Si el mes seleccionado ya pas√≥, mostrar el a√±o siguiente
            return selectedMonth < currentMonth ? currentYear + 1 : currentYear;
        }

        // Funci√≥n para mostrar pr√≥ximo cumplea√±os y recordatorio
        function updateUpcomingBirthdays() {
            const upcomingList = document.getElementById('upcomingList');
            [nextBday, secondBday] = getNextBirthdays();

            const now = new Date();
            const hoyTexto = getFormattedToday();
            const diff = nextBday ? (nextBday.fecha - now) : 0;

            const cumpleHoy = dadesAniversaris.filter(d => d.dia && d.mes && d.dia === now.getDate() && d.mes === (now.getMonth() + 1));
            let hoyMsg = `<div style="font-size: 0.95rem; margin-bottom: 2px; text-align: center;">üìÖ <strong class="glow-text">${hoyTexto}</strong></div>`;

            if (cumpleHoy.length > 0) {
                const nomsArr = cumpleHoy.map(d => d.nom);
                const nomsFormatats = joinNamesCatalan(nomsArr);

                // Determinar si todas las personas est√°n fallecidas
                const todasFallecidas = cumpleHoy.every(p => p.viu === 'No');
                const texto = todasFallecidas ? 'Avui va n√©ixer' : `Avui √©s l'aniversari ${getPrefixForName(nomsArr[0])}`;

                hoyMsg += `<div style="font-size: 1.1rem; margin-top: 3px; text-align: center;">${todasFallecidas ? 'üïäÔ∏è' : 'üéÇ'} ${texto}<strong>${nomsFormatats}</strong></div>`;

                // Mostrar edad o a√±o de nacimiento
                cumpleHoy.forEach(persona => {
                    if (persona.anyNaixement) {
                        const currentYear = now.getFullYear();
                        const age = currentYear - persona.anyNaixement;

                        // Si la persona NO est√° viva, mostrar a√±o de nacimiento
                        if (persona.viu === 'No') {
                            const nascut = persona.genere === 'D' ? 'Nascuda' : 'Nascut';
                            hoyMsg += `<div style="font-size: 1rem; margin-top: 2px; text-align: center; opacity: 0.95;">üïäÔ∏è ${nascut} el <strong>${persona.anyNaixement}</strong></div>`;
                        } else {
                            // Si est√° viva, mostrar edad
                            const verb = cumpleHoy.length === 1 ? 'fa' : `${persona.nom.split(' ')[0]} fa`;
                            hoyMsg += `<div style="font-size: 1rem; margin-top: 2px; text-align: center; opacity: 0.95;">üéÇ ${cumpleHoy.length === 1 ? 'Fa' : verb} <strong>${age} anys</strong> avui</div>`;
                        }
                    }
                });
            }

            if (!nextBday) {
                upcomingList.innerHTML = hoyMsg;
                return;
            }

            if (diff <= 0) {
                // Si hay cumplea√±os hoy, ya se muestra en hoyMsg, no duplicar
                upcomingList.innerHTML = hoyMsg;
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            // Buscar persona completa para obtener anyNaixement y estado
            const nextPerson = dadesAniversaris.find(d => d.nom === nextBday.nom && d.dia === nextBday.dia && d.mes === nextBday.mes);
            let ageText = '';
            if (nextPerson && nextPerson.anyNaixement) {
                const nextBirthdayYear = nextBday.fecha.getFullYear();
                const age = nextBirthdayYear - nextPerson.anyNaixement;

                // Si la persona NO est√° viva, mostrar a√±o de nacimiento
                if (nextPerson.viu === 'No') {
                    const nascut = nextPerson.genere === 'D' ? 'Nascuda' : 'Nascut';
                    ageText = `<div style="font-size: 1rem; margin-top: 2px; opacity: 0.95;">üïäÔ∏è ${nascut} el <strong>${nextPerson.anyNaixement}</strong></div>`;
                } else {
                    ageText = `<div style="font-size: 1rem; margin-top: 2px; opacity: 0.95;">üéÇ Far√† <strong>${age} anys</strong></div>`;
                }
            }

            const secondLine = "";

            upcomingList.innerHTML = `
                ${hoyMsg}
                <div style="margin: 6px 0; text-align: center;">
                    <div class="glow-text" style="font-size: 1.05rem; margin-bottom: 2px;">üéâ Pr√≤xim aniversari:</div>
                    <div style="font-size: 1.2rem; font-weight: 700; margin: 2px 0;"><strong>${nextBday.nom}</strong></div>
                    <div style="font-size: 0.9rem; margin-top: 2px; opacity: 0.95;">${nextBday.dia} ${getMesName(nextBday.mes)}</div>
                    ${ageText}
                    <div class="pulse-counter" style="font-size: 1.4rem; margin-top: 5px; font-weight: 700; display: inline-block;">‚è≥ ${days} dies, ${hours}h ${minutes}m ${seconds}s</div>
                </div>
                ${secondLine}
            `;
        }

        // Funci√≥n para actualizar estad√≠sticas del mes
        function updateMonthStats(mes) {
            const aniversarisMes = dadesAniversaris.filter(d => d.mes === parseInt(mes));

            // Tarjeta izquierda: Mes + Frase motivadora
            const statMonth = document.getElementById('statMonth');
            const statMotivation = document.getElementById('statMotivation');

            statMonth.textContent = getMesName(parseInt(mes));
            statMotivation.textContent = frasesMotivadores[parseInt(mes) - 1];

            // Tarjeta derecha: Lista de todos los aniversarios del mes
            const statBirthdayList = document.getElementById('statBirthdayList');

            if (aniversarisMes.length === 0) {
                statBirthdayList.innerHTML = '<span style="color: #999;">Cap aniversari</span>';
            } else {
                // Ordenar por d√≠a
                const sorted = aniversarisMes.sort((a, b) => a.dia - b.dia);
                statBirthdayList.innerHTML = sorted.map(b =>
                    `<div style="margin-bottom: 5px;">
                        <strong>${b.dia}</strong> - ${b.nom}
                    </div>`
                ).join('');
            }
        }

        // Variables para b√∫squeda y filtrado
        let filteredData = [];
        let currentSearchTerm = '';

        // Funci√≥n de b√∫squeda
        function searchBirthdays(searchTerm) {
            currentSearchTerm = searchTerm.toLowerCase();

            if (!currentSearchTerm) {
                filteredData = [];
                return dadesAniversaris;
            }

            filteredData = dadesAniversaris.filter(d =>
                d.nom.toLowerCase().includes(currentSearchTerm)
            );

            return filteredData;
        }

        // Funci√≥n para mostrar detalles en modal
        function showBirthdayDetails(persona) {
            const modal = document.getElementById('detailsModal');
            const today = new Date();
            const currentYear = today.getFullYear();
            const birthdayThisYear = new Date(currentYear, persona.mes - 1, persona.dia);
            const birthdayDate = birthdayThisYear < today ?
                new Date(currentYear + 1, persona.mes - 1, persona.dia) : birthdayThisYear;

            const daysUntil = Math.floor((birthdayDate - today) / (1000 * 60 * 60 * 24));

            // Guardar persona actual para edici√≥n
            currentEditingPerson = persona;

            // Restaurar display normal
            document.getElementById('detailsDate').parentElement.innerHTML = `<strong>üìÖ Data:</strong> <span id="detailsDate">${persona.dia} de ${getMesName(persona.mes)}</span>`;

            // Mostrar edad si existe anyNaixement
            const ageContainer = document.getElementById('detailsAgeContainer');
            if (persona.anyNaixement) {
                const nextBirthdayYear = birthdayDate.getFullYear();
                const age = nextBirthdayYear - persona.anyNaixement;
                const currentAge = today > birthdayThisYear ? age : age - 1;
                document.getElementById('detailsAge').textContent = `${currentAge} anys (far√† ${age} anys)`;
                ageContainer.style.display = 'block';
            } else {
                ageContainer.style.display = 'none';
            }

            document.getElementById('detailsPhone').parentElement.innerHTML = `<strong>üìû Tel√®fon:</strong> <span id="detailsPhone">${persona.telefon || 'No disponible'}</span>`;
            document.getElementById('detailsEmail').parentElement.innerHTML = `<strong>üìß Email:</strong> <span id="detailsEmail">${persona.email || 'No disponible'}</span>`;
            document.getElementById('detailsDays').parentElement.style.display = 'block';
            document.getElementById('detailsDays').parentElement.innerHTML = `<strong>‚è∞ Dies fins al pr√≤xim aniversari:</strong> <span id="detailsDays">${daysUntil === 0 ? 'Avui!' : daysUntil + ' dies'}</span>`;

            document.getElementById('detailsName').textContent = persona.nom;

            // Mostrar informaci√≥n de relaciones familiares
            const familyInfoHtml = buildFamilyInfoHtml(persona);
            const detailsContent = document.querySelector('.details-content');
            let existingFamilyInfo = document.getElementById('familyRelationsInfo');

            if (existingFamilyInfo) {
                existingFamilyInfo.remove();
            }

            if (familyInfoHtml) {
                const familyDiv = document.createElement('div');
                familyDiv.id = 'familyRelationsInfo';
                familyDiv.style.cssText = 'margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;';
                familyDiv.innerHTML = familyInfoHtml;

                const buttonsContainer = detailsContent.querySelector('.details-buttons');
                if (buttonsContainer) {
                    detailsContent.insertBefore(familyDiv, buttonsContainer);
                } else {
                    detailsContent.appendChild(familyDiv);
                }
            }

            modal.classList.add('show');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('show');
        }

        // Funci√≥n para toggle de modo oscuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        }

        // ============================================
        // M√ìDULO DE √ÅRBOL GENEAL√ìGICO
        // ============================================

        // Variables globales para D3.js
        let familyTreeSvg, familyTreeG, familyTreeZoom;

        /**
         * Abrir modal del √°rbol geneal√≥gico
         */
        function openFamilyTree() {
            const modal = document.getElementById('familyTreeModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Renderizar √°rbol despu√©s de un breve delay para que el modal se abra
            setTimeout(() => {
                renderFamilyTree();
            }, 100);
        }

        /**
         * Cerrar modal del √°rbol geneal√≥gico
         */
        function closeFamilyTree() {
            const modal = document.getElementById('familyTreeModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        /**
         * Poblar dropdowns de relaciones familiares
         */
        function populateFamilyDropdowns(excludeRowNumber = null) {
            const pareSelect = document.getElementById('formPare');
            const mareSelect = document.getElementById('formMare');
            const parellaSelect = document.getElementById('formParella');

            // Limpiar opciones existentes
            pareSelect.innerHTML = '<option value="">No especificat</option>';
            mareSelect.innerHTML = '<option value="">No especificat</option>';
            parellaSelect.innerHTML = '<option value="">No especificat</option>';

            // Filtrar todas las personas (incluyendo fallecidas) y ordenar por nombre
            const allPeople = dadesAniversaris
                .filter(p => p.rowNumber !== excludeRowNumber)
                .sort((a, b) => a.nom.localeCompare(b.nom, 'ca'));

            // Poblar Pare (solo hombres)
            allPeople.filter(p => p.genere === 'H').forEach(p => {
                const option = document.createElement('option');
                option.value = p.rowNumber;
                const age = p.anyNaixement ? ` (${new Date().getFullYear() - p.anyNaixement} anys)` : '';
                const deceased = p.viu === 'No' ? ' üïäÔ∏è' : '';
                option.textContent = `${p.nom}${age}${deceased}`;
                pareSelect.appendChild(option);
            });

            // Poblar Mare (solo mujeres)
            allPeople.filter(p => p.genere === 'D').forEach(p => {
                const option = document.createElement('option');
                option.value = p.rowNumber;
                const age = p.anyNaixement ? ` (${new Date().getFullYear() - p.anyNaixement} anys)` : '';
                const deceased = p.viu === 'No' ? ' üïäÔ∏è' : '';
                option.textContent = `${p.nom}${age}${deceased}`;
                mareSelect.appendChild(option);
            });

            // Poblar Parella (todos)
            allPeople.forEach(p => {
                const option = document.createElement('option');
                option.value = p.rowNumber;
                const icon = p.genere === 'H' ? 'üë®' : p.genere === 'D' ? 'üë©' : '';
                const age = p.anyNaixement ? ` (${new Date().getFullYear() - p.anyNaixement} anys)` : '';
                const deceased = p.viu === 'No' ? ' üïäÔ∏è' : '';
                option.textContent = `${icon} ${p.nom}${age}${deceased}`;
                parellaSelect.appendChild(option);
            });
        }

        /**
         * Construir estructura jer√°rquica para D3.js
         */
        function buildFamilyHierarchy() {
            // 1. Crear mapa de personas por rowNumber
            const peopleMap = new Map();
            dadesAniversaris.forEach(person => {
                peopleMap.set(person.rowNumber, {
                    ...person,
                    children: []
                });
            });

            // 2. NUEVO: Detectar parejas con hijos comunes y crear nodos de uni√≥n
            const coupleUnions = new Map(); // key: "pareId-mareId"
            const childrenAssigned = new Set(); // Rastrear hijos asignados a uniones

            dadesAniversaris.forEach(person => {
                const hasPare = person.pareId && peopleMap.has(person.pareId);
                const hasMare = person.mareId && peopleMap.has(person.mareId);

                // Si tiene AMBOS padres, es hijo com√∫n de una pareja
                if (hasPare && hasMare) {
                    const coupleKey = `${person.pareId}-${person.mareId}`;

                    // Crear nodo de uni√≥n si no existe
                    if (!coupleUnions.has(coupleKey)) {
                        const pare = peopleMap.get(person.pareId);
                        const mare = peopleMap.get(person.mareId);

                        coupleUnions.set(coupleKey, {
                            isCoupleUnion: true,
                            coupleKey: coupleKey,
                            pareId: person.pareId,
                            mareId: person.mareId,
                            pareName: pare.nom,
                            mareName: mare.nom,
                            children: [],
                            virtual: true,
                            nom: 'üíë'
                        });
                    }

                    // Agregar hijo al nodo de uni√≥n
                    coupleUnions.get(coupleKey).children.push(
                        peopleMap.get(person.rowNumber)
                    );
                    childrenAssigned.add(person.rowNumber);
                }
            });

            // 3. Construir jerarqu√≠a principal (SOLO hijos NO comunes)
            const roots = [];

            dadesAniversaris.forEach(person => {
                // Saltar si ya fue asignado como hijo com√∫n
                if (childrenAssigned.has(person.rowNumber)) {
                    return;
                }

                const hasPare = person.pareId && peopleMap.has(person.pareId);
                const hasMare = person.mareId && peopleMap.has(person.mareId);

                if (!hasPare && !hasMare) {
                    // Es una ra√≠z
                    roots.push(peopleMap.get(person.rowNumber));
                } else {
                    // Agregar como hijo del padre o madre (solo un padre conocido)
                    if (hasPare) {
                        peopleMap.get(person.pareId).children.push(
                            peopleMap.get(person.rowNumber)
                        );
                    } else if (hasMare) {
                        peopleMap.get(person.mareId).children.push(
                            peopleMap.get(person.rowNumber)
                        );
                    }
                }
            });

            // 4. NUEVO: Insertar nodos de uni√≥n en la jerarqu√≠a
            coupleUnions.forEach((coupleNode) => {
                const pare = peopleMap.get(coupleNode.pareId);
                const mare = peopleMap.get(coupleNode.mareId);

                // Agregar nodo de uni√≥n como hijo del padre
                pare.children.push(coupleNode);

                // Guardar referencia a la madre para renderizado de enlace de pareja
                coupleNode.partnerNode = mare;
            });

            // 5. Retornar ra√≠z √∫nica o nodo virtual
            if (roots.length === 0 && dadesAniversaris.length > 0) {
                return {
                    nom: 'Fam√≠lia',
                    virtual: true,
                    children: Array.from(peopleMap.values()).filter(p =>
                        !p.pareId && !p.mareId && !childrenAssigned.has(p.rowNumber)
                    )
                };
            }

            if (roots.length === 1) {
                return roots[0];
            }

            return {
                nom: 'Fam√≠lia',
                virtual: true,
                children: roots
            };
        }

        /**
         * Obtener iniciales de un nombre
         */
        function getInitials(name) {
            if (!name) return '??';
            const parts = name.trim().split(' ');
            if (parts.length === 1) {
                return parts[0].substring(0, 2).toUpperCase();
            }
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }

        /**
         * Renderizar √°rbol geneal√≥gico con D3.js
         */
        function renderFamilyTree() {
            const container = document.getElementById('familyTreeContainer');

            // Limpiar SVG anterior (pero mantener controles y leyenda)
            const existingSvg = container.querySelector('svg');
            if (existingSvg) {
                existingSvg.remove();
            }

            // Si no hay datos, mostrar mensaje
            if (dadesAniversaris.length === 0) {
                const message = document.createElement('div');
                message.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    color: #6c757d;
                    font-size: 1.2rem;
                `;
                message.innerHTML = `
                    <div style="font-size: 4rem; margin-bottom: 20px;">üå≥</div>
                    <div>No hi ha dades per mostrar l'arbre familiar</div>
                `;
                container.insertBefore(message, container.firstChild);
                return;
            }

            // Dimensiones
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Crear SVG
            familyTreeSvg = d3.select('#familyTreeContainer')
                .insert('svg', ':first-child')
                .attr('width', width)
                .attr('height', height);

            // Configurar zoom
            familyTreeZoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on('zoom', (event) => {
                    familyTreeG.attr('transform', event.transform);
                });

            familyTreeSvg.call(familyTreeZoom);

            // Grupo principal
            familyTreeG = familyTreeSvg.append('g');

            // Construir jerarqu√≠a
            const hierarchyData = buildFamilyHierarchy();
            const root = d3.hierarchy(hierarchyData);

            // Configurar layout de √°rbol (MODIFICADO: Mayor separaci√≥n)
            const treeLayout = d3.tree()
                .size([height - 100, width - 200])
                .separation((a, b) => (a.parent === b.parent ? 2 : 2.5));

            // Calcular posiciones
            treeLayout(root);

            // NUEVO: Ajustar posiciones de madres para que est√©n al mismo nivel que padres
            root.descendants().forEach(node => {
                if (node.data.isCoupleUnion) {
                    // Este es un nodo de uni√≥n
                    const pareNode = node.parent; // El padre del nodo de uni√≥n
                    const mareNode = root.descendants().find(
                        d => d.data.rowNumber === node.data.mareId
                    );

                    if (pareNode && mareNode) {
                        // Ajustar la posici√≥n vertical (x en D3 tree) para que est√© al mismo nivel
                        mareNode.x = pareNode.x;
                        // Ajustar posici√≥n horizontal (y en D3 tree) para que est√© cerca
                        mareNode.y = pareNode.y + 50; // Un poco a la derecha del padre
                    }
                }
            });

            // NUEVO: Restaurar posiciones personalizadas guardadas
            const savedPositions = loadNodePositions();
            root.descendants().forEach(node => {
                if (node.data.rowNumber && savedPositions[node.data.rowNumber]) {
                    node.x = savedPositions[node.data.rowNumber].x;
                    node.y = savedPositions[node.data.rowNumber].y;
                }
            });

            // NUEVO: Separar enlaces normales y de pareja
            const normalLinks = [];
            const partnerLinks = [];

            root.links().forEach(link => {
                if (link.target.data.isCoupleUnion) {
                    normalLinks.push(link);

                    // Crear enlace de pareja a la madre
                    if (link.target.data.partnerNode) {
                        const mareNode = root.descendants().find(
                            d => d.data.rowNumber === link.target.data.mareId
                        );

                        if (mareNode) {
                            partnerLinks.push({
                                source: link.target,
                                target: mareNode,
                                isPartnerLink: true
                            });
                        }
                    }
                } else {
                    normalLinks.push(link);
                }
            });

            // Renderizar enlaces normales (padre‚Üíhijo, padre‚Üíuni√≥n)
            familyTreeG.selectAll('.tree-link')
                .data(normalLinks)
                .enter()
                .append('path')
                .attr('class', 'tree-link')
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y + 150)
                    .y(d => d.x + 75)
                );

            // NUEVO: Renderizar enlaces de pareja (horizontal, punteado rosa)
            familyTreeG.selectAll('.tree-link-partner')
                .data(partnerLinks)
                .enter()
                .append('line')
                .attr('class', 'tree-link-partner')
                .attr('x1', d => d.source.y + 150)
                .attr('y1', d => d.source.x + 75)
                .attr('x2', d => d.target.y + 150)
                .attr('y2', d => d.target.x + 75);

            // Funci√≥n para actualizar enlaces cuando se arrastran nodos
            function updateLinks() {
                // Actualizar enlaces normales
                familyTreeG.selectAll('.tree-link')
                    .attr('d', d3.linkHorizontal()
                        .x(d => d.y + 150)
                        .y(d => d.x + 75)
                    );

                // Actualizar enlaces de pareja
                familyTreeG.selectAll('.tree-link-partner')
                    .attr('x1', d => d.source.y + 150)
                    .attr('y1', d => d.source.x + 75)
                    .attr('x2', d => d.target.y + 150)
                    .attr('y2', d => d.target.x + 75);
            }

            // Renderizar nodos
            const nodes = familyTreeG.selectAll('.tree-node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', 'tree-node')
                .attr('transform', d => `translate(${d.y + 150}, ${d.x + 75})`)
                .style('cursor', 'move')
                .call(createDragHandler(updateLinks))
                .on('click', (event, d) => {
                    // No permitir click en nodos virtuales ni nodos de uni√≥n
                    if (!d.data.virtual && !d.data.isCoupleUnion) {
                        showBirthdayDetails(d.data);
                    }
                });

            // C√≠rculos de nodos
            nodes.append('circle')
                .attr('class', d => {
                    let classes = 'tree-node-circle';
                    // NUEVO: Clase especial para nodos de uni√≥n
                    if (d.data.isCoupleUnion) {
                        classes += ' couple-union';
                    } else if (d.data.viu === 'No') {
                        classes += ' deceased';
                    } else if (d.data.genere === 'D') {
                        classes += ' female';
                    }
                    return classes;
                })
                .attr('r', d => {
                    // NUEVO: Nodos de uni√≥n m√°s peque√±os
                    if (d.data.isCoupleUnion) return 20;
                    if (d.data.virtual) return 25;
                    return 35;
                });

            // Iniciales en nodos
            nodes.append('text')
                .attr('class', 'tree-node-initials')
                .attr('dy', '0.35em')
                .text(d => {
                    // NUEVO: Icono üíë para nodos de uni√≥n
                    if (d.data.isCoupleUnion) return 'üíë';
                    if (d.data.virtual) return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
                    return getInitials(d.data.nom);
                });

            // Nombres debajo de los nodos (NUEVO: NO mostrar para nodos de uni√≥n)
            nodes.filter(d => !d.data.isCoupleUnion)
                .append('text')
                .attr('class', 'tree-node-text')
                .attr('dy', '3.5em')
                .text(d => {
                    if (d.data.virtual) return d.data.nom;
                    const deceased = d.data.viu === 'No' ? ' üïäÔ∏è' : '';
                    return d.data.nom + deceased;
                });

            // A√±os de nacimiento (NUEVO: Solo para personas reales, no nodos de uni√≥n)
            nodes.filter(d => !d.data.virtual && !d.data.isCoupleUnion && d.data.anyNaixement)
                .append('text')
                .attr('class', 'tree-node-subtext')
                .attr('dy', '5em')
                .text(d => {
                    if (d.data.viu === 'No') {
                        return `(${d.data.anyNaixement} - ?)`;
                    }
                    const age = new Date().getFullYear() - d.data.anyNaixement;
                    return `(${age} anys)`;
                });

            // Centrar vista inicial
            const initialTransform = d3.zoomIdentity
                .translate(100, height / 2)
                .scale(0.8);

            familyTreeSvg.call(familyTreeZoom.transform, initialTransform);
        }

        /**
         * Controles de zoom del √°rbol
         */
        function zoomInTree() {
            if (familyTreeSvg && familyTreeZoom) {
                familyTreeSvg.transition().duration(300).call(
                    familyTreeZoom.scaleBy, 1.3
                );
            }
        }

        function zoomOutTree() {
            if (familyTreeSvg && familyTreeZoom) {
                familyTreeSvg.transition().duration(300).call(
                    familyTreeZoom.scaleBy, 0.7
                );
            }
        }

        function resetZoomTree() {
            if (familyTreeSvg && familyTreeZoom) {
                const container = document.getElementById('familyTreeContainer');
                const height = container.clientHeight;

                const resetTransform = d3.zoomIdentity
                    .translate(100, height / 2)
                    .scale(0.8);

                familyTreeSvg.transition().duration(750).call(
                    familyTreeZoom.transform, resetTransform
                );
            }
        }

        /**
         * Resetear layout del √°rbol (borrar posiciones personalizadas)
         */
        function resetTreeLayout() {
            if (confirm('Aix√≤ reiniciar√† totes les posicions personalitzades dels nodes. Continuar?')) {
                localStorage.removeItem('familyTreePositions');
                renderFamilyTree();
            }
        }

        /**
         * Guardar posiciones personalizadas de nodos
         */
        function saveNodePositions(positions) {
            try {
                localStorage.setItem('familyTreePositions', JSON.stringify(positions));
            } catch (e) {
                console.error('Error guardant posicions:', e);
            }
        }

        /**
         * Cargar posiciones personalizadas de nodos
         */
        function loadNodePositions() {
            try {
                const saved = localStorage.getItem('familyTreePositions');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('Error carregant posicions:', e);
                return {};
            }
        }

        /**
         * Crear handler de drag para nodos
         */
        function createDragHandler(updateLinks) {
            function dragStarted(event, d) {
                d3.select(this).raise().classed('dragging', true);
            }

            function dragged(event, d) {
                // Actualizar posici√≥n del nodo
                d.x = event.y - 75;
                d.y = event.x - 150;

                d3.select(this).attr('transform', `translate(${event.x}, ${event.y})`);

                // Actualizar enlaces conectados
                updateLinks();
            }

            function dragEnded(event, d) {
                d3.select(this).classed('dragging', false);

                // Guardar posiciones
                const positions = {};
                d3.selectAll('.tree-node').each(function(node) {
                    if (node.data.rowNumber) {
                        positions[node.data.rowNumber] = {
                            x: node.x,
                            y: node.y
                        };
                    }
                });
                saveNodePositions(positions);
            }

            return d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded);
        }

        /**
         * Construir HTML con informaci√≥n de relaciones familiares
         */
        function buildFamilyInfoHtml(persona) {
            let html = '<div style="font-size: 0.95rem;"><strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Fam√≠lia:</strong><br>';
            let hasRelations = false;

            // Padre
            if (persona.pareId) {
                const pare = dadesAniversaris.find(p => p.rowNumber === persona.pareId);
                if (pare) {
                    html += `<div style="margin-top: 8px;">üë® Pare: ${pare.nom}</div>`;
                    hasRelations = true;
                }
            }

            // Madre
            if (persona.mareId) {
                const mare = dadesAniversaris.find(p => p.rowNumber === persona.mareId);
                if (mare) {
                    html += `<div style="margin-top: 8px;">üë© Mare: ${mare.nom}</div>`;
                    hasRelations = true;
                }
            }

            // Pareja
            if (persona.parellaId) {
                const parella = dadesAniversaris.find(p => p.rowNumber === persona.parellaId);
                if (parella) {
                    const icon = parella.genere === 'H' ? 'üë®' : 'üë©';
                    html += `<div style="margin-top: 8px;">${icon} Parella: ${parella.nom}</div>`;
                    hasRelations = true;
                }
            }

            // Hijos
            const fills = dadesAniversaris.filter(p =>
                p.pareId === persona.rowNumber || p.mareId === persona.rowNumber
            );
            if (fills.length > 0) {
                html += `<div style="margin-top: 8px;">üë∂ Fills: ${fills.map(f => f.nom).join(', ')}</div>`;
                hasRelations = true;
            }

            // Hermanos
            if (persona.pareId || persona.mareId) {
                const germans = dadesAniversaris.filter(p =>
                    p.rowNumber !== persona.rowNumber &&
                    ((p.pareId && p.pareId === persona.pareId) || (p.mareId && p.mareId === persona.mareId))
                );
                if (germans.length > 0) {
                    html += `<div style="margin-top: 8px;">üë´ Germans: ${germans.map(g => g.nom).join(', ')}</div>`;
                    hasRelations = true;
                }
            }

            html += '</div>';
            return hasRelations ? html : '';
        }

        // Listener para cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const treeModal = document.getElementById('familyTreeModal');
                if (treeModal.classList.contains('show')) {
                    closeFamilyTree();
                }
            }
        });

        // ============================================
        // FIN M√ìDULO DE √ÅRBOL GENEAL√ìGICO
        // ============================================

        // Variables para gesti√≥n de datos
        let currentEditingIndex = -1;
        let currentEditingPerson = null;
        let currentView = 'chart';
        let currentYear = new Date().getFullYear();

        // Funci√≥n para cargar datos desde Google Sheets (con fallback a localStorage)
        async function loadDataFromStorage(refreshUI = false) {
            // Mostrar indicador de carga (DESACTIVADO)
            // const loadingDiv = document.createElement('div');
            // loadingDiv.id = 'loadingIndicator';
            // loadingDiv.style.cssText = `
            //     position: fixed;
            //     top: 50%;
            //     left: 50%;
            //     transform: translate(-50%, -50%);
            //     background: rgba(0,0,0,0.8);
            //     color: white;
            //     padding: 20px 40px;
            //     border-radius: 10px;
            //     z-index: 10001;
            //     font-size: 1rem;
            // `;
            // loadingDiv.innerHTML = '‚è≥ Carregant dades...';
            // document.body.appendChild(loadingDiv);

            try {
                // Intentar cargar desde Google Sheets
                const sheetData = await fetchBirthdays();

                if (sheetData && sheetData.length > 0) {
                    // √âxito: usar datos de Google Sheets
                    dadesAniversaris.length = 0; // Limpiar array existente
                    dadesAniversaris.push(...sheetData);

                    // Guardar en localStorage como cach√©
                    saveDataToStorage();

                    console.log(`‚úÖ Cargados ${sheetData.length} aniversarios desde Google Sheets`);
                    // showSyncMessage('‚úÖ Dades sincronitzades amb Google Sheets');
                } else {
                    // Fallback: usar localStorage si existe
                    const stored = localStorage.getItem('birthdayData');
                    if (stored) {
                        try {
                            const localData = JSON.parse(stored);
                            dadesAniversaris.length = 0;
                            dadesAniversaris.push(...localData);
                            console.log('‚ö†Ô∏è Usando datos de cach√© local');
                            // showSyncMessage('‚ö†Ô∏è Usant dades locals (sense connexi√≥)', true);
                        } catch (e) {
                            console.error('Error cargando desde localStorage:', e);
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);

                // Fallback: usar localStorage
                const stored = localStorage.getItem('birthdayData');
                if (stored) {
                    try {
                        const localData = JSON.parse(stored);
                        dadesAniversaris.length = 0;
                        dadesAniversaris.push(...localData);
                        // showSyncMessage('‚ö†Ô∏è Error de connexi√≥. Usant dades locals', true);
                    } catch (e) {
                        console.error('Error cargando desde localStorage:', e);
                    }
                }
            } finally {
                // Quitar indicador de carga (DESACTIVADO)
                // loadingDiv.remove();
            }

            // Refrescar UI si se solicita
            if (refreshUI) {
                console.log('üîÑ loadDataFromStorage amb refreshUI=true, cridant refreshAllViews()');
                refreshAllViews();
            }
        }

        // Funci√≥n para guardar datos en localStorage
        function saveDataToStorage() {
            localStorage.setItem('birthdayData', JSON.stringify(dadesAniversaris));
        }

        // Funci√≥n para switch entre vistas
        // Funci√≥n para renderizar resultados de b√∫squeda
        function renderSearchResults() {
            const searchResultsContainer = document.getElementById('searchResults');

            // Si no hay b√∫squeda, ocultar resultados
            if (filteredData.length === 0 && !currentSearchTerm) {
                searchResultsContainer.style.display = 'none';
                searchResultsContainer.innerHTML = '';
                return;
            }

            // Mostrar contenedor de resultados
            searchResultsContainer.style.display = 'block';

            if (filteredData.length === 0) {
                searchResultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 12px; color: #666;">
                        <h3 style="margin: 0 0 5px 0;">üòï No s'han trobat resultats</h3>
                        <p style="margin: 0;">Prova amb un altre nom</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="padding: 15px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 15px 0; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.1rem;">
                        üîç ${filteredData.length} resultat${filteredData.length !== 1 ? 's' : ''} trobat${filteredData.length !== 1 ? 's' : ''}
                    </h3>
                    <div style="display: grid; gap: 10px;">
            `;

            filteredData.forEach(person => {
                const mesNom = getMesName(person.mes);
                html += `
                    <div onclick='showBirthdayDetails(${JSON.stringify(person).replace(/'/g, "\\'")})'
                         style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 10px; color: white; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1)'">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 3px;">${person.nom}</div>
                        <div style="opacity: 0.9; font-size: 0.85rem;">üìÖ ${person.dia} de ${mesNom}</div>
                        ${person.telefon ? `<div style="opacity: 0.9; font-size: 0.85rem;">üì± ${person.telefon}</div>` : ''}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            searchResultsContainer.innerHTML = html;
        }

        // Funci√≥n centralizada para refrescar todas las vistas
        function refreshAllViews() {
            console.log('üîÑ refreshAllViews() called');
            console.log('üìä Datos actuals:', dadesAniversaris.length, 'aniversaris');

            const mesSelector = document.getElementById('mesSelector');
            const currentMonth = parseInt(mesSelector.value);
            console.log('üìÖ Mes actual:', currentMonth);

            // Detectar quin tipus de vista est√† visible
            const calendarView = document.getElementById('calendarView');
            const chartContainer = document.getElementById('chartContainer');

            // Refrescar vista actual basant-nos en qu√® est√† visible al DOM
            if (chartContainer && chartContainer.style.display !== 'none') {
                console.log('üìà Refrescant gr√†fic...');
                actualitzarGrafic(currentMonth);
            } else if (calendarView) {
                console.log('üìÜ Refrescant calendari...');
                renderCalendar(currentMonth, currentYear);
            }

            // Refrescar widgets dependientes
            updateUpcomingBirthdays();
            updateMonthStats(currentMonth);

            // Si hay b√∫squeda activa, actualizar resultados
            if (currentSearchTerm) {
                renderSearchResults();
            }

            console.log('‚úÖ refreshAllViews() completat');
        }

        // Funci√≥n para renderizar calendario
        function renderCalendar(mes, year = currentYear) {
            year = year || currentYear;
            const firstDay = new Date(year, mes - 1, 1).getDay();
            const daysInMonth = getDiesMes(mes);
            const daysInPrevMonth = getDiesMes(mes - 1);

            const dayNames = ['Dl', 'Dt', 'Dc', 'Dj', 'Dv', 'Ds', 'Dg'];
            const aniversarisMes = dadesAniversaris.filter(d => d.dia && d.mes && d.mes === mes);

            let html = `<div class="calendar-header">
                <h3 style="margin: 0; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.3rem;">${getMesName(mes)} ${year}</h3>
            </div>
            <div class="calendar-grid">`;

            // Headers
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // D√≠as del mes anterior
            const startDay = firstDay === 0 ? 6 : firstDay - 1;
            for (let i = startDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${daysInPrevMonth - i}</div>
                </div>`;
            }

            // D√≠as del mes actual
            const today = new Date();
            const todayDay = today.getDate();
            const todayMonth = today.getMonth() + 1;
            const todayYear = today.getFullYear();

            for (let day = 1; day <= daysInMonth; day++) {
                const birthdays = aniversarisMes.filter(d => d.dia === day);
                const hasBirthday = birthdays.length > 0;
                const birthdayClass = hasBirthday ? 'has-birthday' : '';
                const isToday = (day === todayDay && mes === todayMonth && year === todayYear);
                const todayClass = isToday ? 'is-today' : '';

                html += `<div class="calendar-day ${birthdayClass} ${todayClass}" onclick="showCalendarDayDetails(${day}, ${mes})">
                    <div class="calendar-day-number">${day}</div>`;

                if (hasBirthday) {
                    html += `<div class="calendar-birthday-count">${birthdays.length}</div>`;
                    html += `<div class="calendar-birthday-names">`;
                    birthdays.forEach((b, i) => {
                        if (i < 2) {
                            html += `${b.nom.split(' ')[0]}<br>`;
                        }
                    });
                    if (birthdays.length > 2) {
                        html += `+${birthdays.length - 2}`;
                    }
                    html += `</div>`;
                }

                html += `</div>`;
            }

            // D√≠as del siguiente mes
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${i}</div>
                </div>`;
            }

            html += '</div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        // Funci√≥n para manejar la selecci√≥n del desplegable
        function selectBirthdayFromDropdown(dia, mes) {
            const selector = document.getElementById('birthdaySelector');
            const selectedIndex = parseInt(selector.value);

            if (selectedIndex >= 0 && window.currentDayBirthdays) {
                const selectedBirthday = window.currentDayBirthdays[selectedIndex];
                showBirthdayDetails(selectedBirthday);
            }
        }

        // Funci√≥n para mostrar detalles de un d√≠a del calendario
        function showCalendarDayDetails(dia, mes) {
            const birthdays = dadesAniversaris.filter(d => d.dia && d.mes && d.mes === mes && d.dia === dia);
            if (birthdays.length === 1) {
                showBirthdayDetails(birthdays[0]);
            } else if (birthdays.length > 1) {
                // Mostrar selector desplegable para m√∫ltiples cumplea√±os
                const modal = document.getElementById('detailsModal');
                document.getElementById('detailsName').textContent = `${dia} ${getMesName(mes)}`;
                document.getElementById('detailsDate').parentElement.innerHTML = `<strong>üéÇ Selecciona una persona:</strong>`;

                // Crear selector desplegable
                const selectHTML = `
                    <select id="birthdaySelector" style="width: 100%; padding: 10px; font-size: 1rem; border: 2px solid #6366f1; border-radius: 8px; margin-top: 5px; cursor: pointer;" onchange="selectBirthdayFromDropdown(${dia}, ${mes})">
                        <option value="">-- Tria un aniversari --</option>
                        ${birthdays.map((b, index) =>
                            `<option value="${index}">${b.nom}</option>`
                        ).join('')}
                    </select>
                `;

                document.getElementById('detailsPhone').parentElement.innerHTML = selectHTML;
                document.getElementById('detailsDays').parentElement.style.display = 'none';

                // Guardar birthdays temporalmente para acceder desde el selector
                window.currentDayBirthdays = birthdays;

                modal.classList.add('show');
            }
        }

        // Gesti√≥n de formularios
        function openAddModal() {
            document.getElementById('formTitle').textContent = 'Afegir Aniversari';
            document.getElementById('formNom').value = '';
            document.getElementById('formDia').value = '';
            document.getElementById('formMes').value = '';
            document.getElementById('formAnyNaixement').value = '';
            document.getElementById('formTelefon').value = '';
            document.getElementById('formEmail').value = '';
            document.getElementById('formGenere').value = '';
            document.getElementById('formViu').value = '';

            // Limpiar campos de relaciones familiares
            document.getElementById('formPare').value = '';
            document.getElementById('formMare').value = '';
            document.getElementById('formParella').value = '';
            document.getElementById('formUrlFoto').value = '';

            // Poblar dropdowns de relaciones
            populateFamilyDropdowns();

            document.getElementById('deleteBtn').classList.add('hidden');
            currentEditingIndex = -1;
            currentEditingPerson = null;
            document.getElementById('formModal').classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevenir scroll del body
        }

        function openEditModal() {
            if (!currentEditingPerson) return;

            document.getElementById('formTitle').textContent = 'Editar Aniversari';
            document.getElementById('formNom').value = currentEditingPerson.nom;
            document.getElementById('formDia').value = currentEditingPerson.dia;
            document.getElementById('formMes').value = currentEditingPerson.mes;
            document.getElementById('formAnyNaixement').value = currentEditingPerson.anyNaixement || '';
            document.getElementById('formTelefon').value = currentEditingPerson.telefon || '';
            document.getElementById('formEmail').value = currentEditingPerson.email || '';
            document.getElementById('formGenere').value = currentEditingPerson.genere || '';
            document.getElementById('formViu').value = currentEditingPerson.viu || '';

            // Poblar y cargar valores de relaciones familiares
            populateFamilyDropdowns(currentEditingPerson.rowNumber);
            document.getElementById('formPare').value = currentEditingPerson.pareId || '';
            document.getElementById('formMare').value = currentEditingPerson.mareId || '';
            document.getElementById('formParella').value = currentEditingPerson.parellaId || '';
            document.getElementById('formUrlFoto').value = currentEditingPerson.urlFoto || '';

            document.getElementById('deleteBtn').classList.remove('hidden');

            // Encontrar √≠ndice Y preservar rowNumber para identificaci√≥n precisa
            // Si hay rowNumber, usarlo para mayor precisi√≥n; si no, usar solo nom/dia/mes
            currentEditingIndex = dadesAniversaris.findIndex(d => {
                if (currentEditingPerson.rowNumber && d.rowNumber) {
                    // Si ambos tienen rowNumber, usarlo (m√°s confiable)
                    return d.rowNumber === currentEditingPerson.rowNumber;
                } else {
                    // Fallback a comparaci√≥n por nom, dia, mes
                    return d.nom === currentEditingPerson.nom &&
                           d.dia === currentEditingPerson.dia &&
                           d.mes === currentEditingPerson.mes;
                }
            });

            console.log('openEditModal - currentEditingPerson:', currentEditingPerson);
            console.log('openEditModal - currentEditingIndex:', currentEditingIndex);
            console.log('openEditModal - dadesAniversaris[0] example:', dadesAniversaris[0]);

            closeDetailsModal();
            document.getElementById('formModal').classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevenir scroll del body
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.remove('show');
            currentEditingIndex = -1;
            currentEditingPerson = null;
            document.body.style.overflow = ''; // Restaurar scroll del body
        }

        async function saveBirthday() {
            const nom = document.getElementById('formNom').value.trim();
            const dia = parseInt(document.getElementById('formDia').value);
            const mes = parseInt(document.getElementById('formMes').value);
            const anyNaixement = document.getElementById('formAnyNaixement').value ? parseInt(document.getElementById('formAnyNaixement').value) : null;
            let telefon = document.getElementById('formTelefon').value.trim();
            let email = document.getElementById('formEmail').value.trim();
            const genere = document.getElementById('formGenere').value;
            const viu = document.getElementById('formViu').value;

            // Validar campos obligatorios y mostrar modal si falta alguno
            const missingFields = [];
            if (!nom) missingFields.push('Nom');
            if (!dia) missingFields.push('Dia');
            if (!mes) missingFields.push('Mes');
            if (!anyNaixement) missingFields.push('Any de naixement');
            if (!telefon) missingFields.push('Tel√®fon');
            if (!email) missingFields.push('Email');
            if (!genere) missingFields.push('G√®nere');
            if (!viu) missingFields.push('Estat');

            if (missingFields.length > 0) {
                showConfirmModal(missingFields);
                return;
            }

            // Continuar con el guardado normal
            await saveBirthdayConfirmed();
        }

        // Funci√≥n que realmente guarda el cumplea√±os (se llama despu√©s de validar o confirmar)
        async function saveBirthdayConfirmed() {
            const nom = document.getElementById('formNom').value.trim();
            const dia = parseInt(document.getElementById('formDia').value);
            const mes = parseInt(document.getElementById('formMes').value);
            const anyNaixement = document.getElementById('formAnyNaixement').value ? parseInt(document.getElementById('formAnyNaixement').value) : null;
            let telefon = document.getElementById('formTelefon').value.trim();
            let email = document.getElementById('formEmail').value.trim();
            const genere = document.getElementById('formGenere').value;
            const viu = document.getElementById('formViu').value;

            // Capturar campos de relaciones familiares
            const pareId = document.getElementById('formPare').value ? parseInt(document.getElementById('formPare').value) : null;
            const mareId = document.getElementById('formMare').value ? parseInt(document.getElementById('formMare').value) : null;
            const parellaId = document.getElementById('formParella').value ? parseInt(document.getElementById('formParella').value) : null;
            const urlFoto = document.getElementById('formUrlFoto').value.trim();

            // Validar relaciones circulares
            if (pareId && mareId && pareId === mareId) {
                alert('El pare i la mare no poden ser la mateixa persona');
                return;
            }

            if (currentEditingPerson && currentEditingPerson.rowNumber) {
                if (pareId === currentEditingPerson.rowNumber) {
                    alert('Una persona no pot ser el seu propi pare');
                    return;
                }
                if (mareId === currentEditingPerson.rowNumber) {
                    alert('Una persona no pot ser la seva pr√≤pia mare');
                    return;
                }
                if (parellaId === currentEditingPerson.rowNumber) {
                    alert('Una persona no pot ser la seva pr√≤pia parella');
                    return;
                }
            }

            // Validaciones b√°sicas de formato
            if (dia < 1 || dia > 31) {
                alert('El dia ha de ser entre 1 i 31');
                return;
            }

            if (mes < 1 || mes > 12) {
                alert('El mes ha de ser entre 1 (Gener) i 12 (Desembre)');
                return;
            }

            // Validar que el d√≠a sea correcto seg√∫n el mes
            const diasPorMes = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            const maxDia = diasPorMes[mes - 1];

            if (dia > maxDia) {
                const nombresMeses = ['Gener', 'Febrer', 'Mar√ß', 'Abril', 'Maig', 'Juny', 'Juliol', 'Agost', 'Setembre', 'Octubre', 'Novembre', 'Desembre'];
                alert(`El mes de ${nombresMeses[mes - 1]} nom√©s t√© ${maxDia} dies`);
                return;
            }

            // Validar formato de tel√©fono si se ha introducido
            if (telefon) {
                // Remover espacios, guiones y par√©ntesis
                telefon = telefon.replace(/[\s\-\(\)]/g, '');

                // Validar que solo contenga n√∫meros y opcionalmente +
                const telefonRegex = /^\+?[0-9]{9,15}$/;
                if (!telefonRegex.test(telefon)) {
                    alert('El tel√®fon ha de tenir entre 9 i 15 d√≠gits i pot comen√ßar amb +\nExemple: +34666777888 o 666777888');
                    return;
                }
            }

            // Validar formato de email si se ha introducido
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('El format del correu electr√≤nic no √©s v√†lid\nExemple: nom@exemple.com');
                    return;
                }
            }

            const isEditing = currentEditingIndex >= 0;
            const oldBirthday = isEditing ? { ...dadesAniversaris[currentEditingIndex] } : null; // Deep copy para preservar rowNumber

            const newBirthday = { nom, dia, mes, anyNaixement, telefon, email, genere, viu, pareId, mareId, parellaId, urlFoto };

            // Si est√° editando, preservar rowNumber del dato antiguo
            if (isEditing && oldBirthday && oldBirthday.rowNumber) {
                newBirthday.rowNumber = oldBirthday.rowNumber;
            }

            // Actualizar datos localmente (inmediato)
            if (isEditing) {
                // Editar existente - preservar rowNumber
                dadesAniversaris[currentEditingIndex] = newBirthday;
            } else {
                // Agregar nuevo - no rowNumber a√∫n (se asignar√° despu√©s del sync)
                dadesAniversaris.push(newBirthday);
            }

            saveDataToStorage();
            closeFormModal();

            // Refrescar vistas inmediatamente
            const mesSelector = document.getElementById('mesSelector');
            const selectedMonth = parseInt(mesSelector.value);
            renderCalendar(selectedMonth, getYearForMonth(selectedMonth));
            updateUpcomingBirthdays();
            updateMonthStats(mesSelector.value);

            // Sincronizar con Google Sheets en segundo plano
            if (isEditing) {
                // Actualizar en Google Sheets - enviar oldBirthday con rowNumber
                const success = await updateBirthdayInSheet(oldBirthday, newBirthday);
                if (success) {
                    // Recargar datos para refrescar rowNumbers
                    await loadDataFromStorage(true);
                    showSyncMessage('‚úÖ Canvis fets', false);
                } else {
                    showSyncMessage('‚ö†Ô∏è Error al sincronitzar. Canvis guardats localment', true);
                }
            } else {
                // A√±adir a Google Sheets
                const result = await addBirthdayToSheet(newBirthday);

                // Manejar diferentes tipos de error
                if (result && result.success === false) {
                    // Revertir cambio local
                    dadesAniversaris.pop();
                    saveDataToStorage();
                    const selectedMonth2 = parseInt(mesSelector.value);
                    renderCalendar(selectedMonth2, getYearForMonth(selectedMonth2));
                    updateUpcomingBirthdays();
                    updateMonthStats(mesSelector.value);

                    if (result.tipo === 'duplicadoExacto') {
                        alert(result.error);
                        return;
                    }

                    if (result.tipo === 'nombresSimilares') {
                        const confirmar = confirm(
                            result.error + '\n\n' +
                            'Vols afegir igualment "' + nom + '"?'
                        );

                        if (confirmar) {
                            // Usuario confirma: forzar creaci√≥n
                            const resultForzado = await addBirthdayToSheetForzado(newBirthday);

                            if (resultForzado && resultForzado.success) {
                                // Agregar localmente de nuevo
                                dadesAniversaris.push(newBirthday);
                                saveDataToStorage();
                                const selectedMonth3 = parseInt(mesSelector.value);
                                renderCalendar(selectedMonth3, getYearForMonth(selectedMonth3));
                                updateUpcomingBirthdays();
                                updateMonthStats(mesSelector.value);
                                await loadDataFromStorage(true);
                                showSyncMessage('‚úÖ Canvis fets', false);
                            } else {
                                alert('Error al afegir aniversari: ' + (resultForzado?.error || 'Error desconegut'));
                            }
                        }
                        return;
                    }

                    alert(result.error || 'Error al afegir aniversari');
                    return;
                }

                if (result && result.success) {
                    // Recargar datos para obtener rowNumber asignado
                    await loadDataFromStorage(true);
                    showSyncMessage('‚úÖ Canvis fets', false);
                }
            }
        }

        // Funciones para manejar el modal de confirmaci√≥n de campos incompletos
        function showConfirmModal(missingFields) {
            const modal = document.getElementById('confirmModal');
            const list = document.getElementById('missingFieldsList');

            // Limpiar lista anterior
            list.innerHTML = '';

            // Agregar campos faltantes a la lista
            missingFields.forEach(field => {
                const li = document.createElement('li');
                li.textContent = field;
                list.appendChild(li);
            });

            // Mostrar modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        async function saveAnywayConfirmed() {
            closeConfirmModal();
            await saveBirthdayConfirmed();
        }

        async function deleteBirthday() {
            console.log('deleteBirthday called, currentEditingIndex:', currentEditingIndex);
            console.log('currentEditingPerson:', currentEditingPerson);

            if (currentEditingIndex < 0) {
                console.error('No se puede eliminar: currentEditingIndex es', currentEditingIndex);
                alert('Error: No se ha seleccionado ning√∫n aniversario para eliminar');
                return;
            }

            if (confirm('Est√†s segur que vols eliminar aquest aniversari?')) {
                // Guardar referencia completa antes de eliminar (incluye rowNumber)
                const deletedBirthday = { ...dadesAniversaris[currentEditingIndex] };

                // Eliminar localmente (inmediato)
                dadesAniversaris.splice(currentEditingIndex, 1);
                saveDataToStorage();
                closeFormModal();

                // Refrescar vistas inmediatamente
                const mesSelector = document.getElementById('mesSelector');
                if (currentView === 'chart') {
                    actualitzarGrafic(mesSelector.value);
                } else {
                    const selectedMonth4 = parseInt(mesSelector.value);
                    renderCalendar(selectedMonth4, getYearForMonth(selectedMonth4));
                }

                updateUpcomingBirthdays();
                updateMonthStats(mesSelector.value);

                // Sincronizar con Google Sheets en segundo plano
                console.log('üóëÔ∏è Eliminant de Google Sheets:', deletedBirthday.nom);
                const success = await deleteBirthdayFromSheet(deletedBirthday);
                console.log('üìù Resultat eliminaci√≥:', success ? '√àxit' : 'Error');

                if (success) {
                    console.log('üì• Recarregant dades de Google Sheets...');
                    // Recargar datos para refrescar rowNumbers despu√©s de eliminaci√≥n
                    await loadDataFromStorage(true);
                    console.log('‚úÖ Dades recarregades i calendari refrescat');
                    showSyncMessage('‚úÖ Canvis fets', false);
                } else {
                    showSyncMessage('‚ö†Ô∏è Error al sincronitzar. Canvis guardats localment', true);
                }
            }
        }

        // Gestos m√≥viles (swipe)
        let touchStartX = 0;
        let touchEndX = 0;

        function handleSwipe() {
            const threshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > threshold) {
                const mesSelector = document.getElementById('mesSelector');
                let currentMes = parseInt(mesSelector.value);

                if (diff > 0) {
                    // Swipe left - siguiente mes
                    if (currentMes === 12) {
                        currentMes = 1;
                        currentYear++; // Incrementar a√±o
                    } else {
                        currentMes++;
                    }
                } else {
                    // Swipe right - mes anterior
                    if (currentMes === 1) {
                        currentMes = 12;
                        currentYear--; // Decrementar a√±o
                    } else {
                        currentMes--;
                    }
                }

                mesSelector.value = currentMes;
                renderCalendar(currentMes, currentYear);
                updateMonthStats(currentMes);
            }
        }

        async function initializeApp() {
            // Cargar datos desde Google Sheets
            await loadDataFromStorage();

            const mesActual = new Date().getMonth() + 1;
            const mesSelector = document.getElementById('mesSelector');
            const mesos = ["Gener", "Febrer", "Mar√ß", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];

            // Limpiar opciones existentes antes de a√±adir nuevas
            mesSelector.innerHTML = '';

            // Llenar el selector de meses
            mesos.forEach((mes, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.text = mes;
                mesSelector.appendChild(option);
            });

            mesSelector.value = mesActual;
            renderCalendar(mesActual, currentYear);
            updateMonthStats(mesActual);

            // A√±adir event listener para cambio de mes
            mesSelector.addEventListener('change', function() {
                const selectedMonth = parseInt(this.value);
                renderCalendar(selectedMonth, getYearForMonth(selectedMonth));
                updateMonthStats(this.value);
            });
            // Event listener para b√∫squeda
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                searchBirthdays(searchTerm);
                renderSearchResults(); // Mostrar resultados en contenedor separado
            });

            // Event listener para cerrar modal al hacer click fuera
            document.getElementById('detailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDetailsModal();
                }
            });

            // Event listener para toggle de tema
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);

            // Inicializar modo oscuro si estaba activado
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }

            checkMobileSize();

            // Iniciar widget de pr√≥ximo cumplea√±os
            updateUpcomingBirthdays();
            setInterval(updateUpcomingBirthdays, 1000); // Cada segundo para actualizar el contador

            // Mostrar botones flotantes
            document.getElementById('addBtn').classList.remove('hidden');
            document.getElementById('treeBtn').classList.remove('hidden');

            // Event listeners para swipe
            const container = document.querySelector('.container');
            container.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            container.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            // Event listener para cerrar modal de formulario al hacer click fuera
            document.getElementById('formModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFormModal();
                }
            });

            // Cargar datos al inicio si hay en localStorage
            loadDataFromStorage();
        }

        function checkMobileSize() {
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.imatge-container img').forEach(img => {
                    img.style.maxWidth = '90%';
                });
            } else {
                document.querySelectorAll('.imatge-container img').forEach(img => {
                    img.style.maxWidth = '60%';
                });
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Comprobar si ya estamos autenticados y la sesi√≥n es v√°lida
            if (isSessionValid()) {
                document.getElementById('passwordModal').style.display = 'none';
                document.querySelector('.mainContent').classList.remove('hidden');
                initializeApp();
            } else {
                // Limpiar datos de autenticaci√≥n expirados
                localStorage.removeItem('victorCatalaAuth');
                localStorage.removeItem('victorCatalaAuthTime');
            }

            // Event listener para Enter en la contrase√±a
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // Event listener para cerrar sesi√≥n
            document.getElementById('logoutButton').addEventListener('click', function() {
                localStorage.removeItem('victorCatalaAuth');
                localStorage.removeItem('victorCatalaAuthTime');
                document.getElementById('passwordModal').style.display = 'flex';
                document.querySelector('.mainContent').classList.add('hidden');
                document.getElementById('passwordInput').value = '';
            });
        });
        
        // Ajustar tama√±o al cambiar la orientaci√≥n del dispositivo
        window.addEventListener('resize', function() {
            checkMobileSize();
            const mesSelector = document.getElementById('mesSelector');
            if (mesSelector && mesSelector.value) {
                renderCalendar(parseInt(mesSelector.value), currentYear);
            }
        });

        // Activar animaciones al tocar el widget
        document.addEventListener('DOMContentLoaded', function() {
            const widget = document.getElementById('upcomingWidget');
            let animationTimeout;

            if (widget) {
                widget.addEventListener('click', function() {
                    // A√±adir clase active
                    this.classList.add('active');

                    // Limpiar timeout anterior si existe
                    if (animationTimeout) {
                        clearTimeout(animationTimeout);
                    }

                    // Quitar clase despu√©s de 5 segundos
                    animationTimeout = setTimeout(() => {
                        this.classList.remove('active');
                    }, 5000);
                });
            }
        });

        // Control del video para inicio aleatorio
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('escolaVideo');

            if (video) {
                // Cuando se carguen los metadatos del video (duraci√≥n disponible)
                video.addEventListener('loadedmetadata', function() {
                    // Establecer posici√≥n aleatoria entre 0 y la duraci√≥n del video
                    video.currentTime = Math.random() * video.duration;
                });

                // Asegurar que el video vuelva al inicio cuando termine
                // (el atributo loop ya deber√≠a hacer esto, pero por seguridad)
                video.addEventListener('ended', function() {
                    video.currentTime = 0;
                    video.play();
                });
            }
        });
    </script>
</body>
</html>
